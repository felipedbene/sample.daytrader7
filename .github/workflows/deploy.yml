name: DayTrader Spring - Build & Deploy

on:
  push:
    branches: [master]
    paths:
      - 'daytrader-spring/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          cache-dependency-path: daytrader-spring/pom.xml

      - name: Build with Maven
        run: cd daytrader-spring && ./mvnw clean package -DskipTests -B

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: daytrader-spring-jar
          path: daytrader-spring/target/daytrader-spring-*.jar
          retention-days: 5

  deploy:
    name: Deploy to P8
    runs-on: self-hosted
    needs: [build]
    steps:
      - name: Set up SSH key
        run: |
          KEY_FILE=$(mktemp)
          echo "${{ secrets.P8_SSH_KEY }}" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "KEY_FILE=$KEY_FILE" >> "$GITHUB_ENV"

      - name: Deploy on P8 via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i "$KEY_FILE" \
              -o ServerAliveInterval=60 \
              ${{ secrets.P8_SSH_USER }}@${{ secrets.P8_SSH_HOST }} \
              bash -s <<'DEPLOY_SCRIPT'
          set -euo pipefail

          echo "=== Updating repository ==="
          cd ~/sample.daytrader7
          git pull

          echo "=== Building on P8 (ppc64le) ==="
          cd daytrader-spring
          ./mvnw clean package -DskipTests -B

          echo "=== Stopping existing process ==="
          pkill -f daytrader-spring || true
          sleep 3

          echo "=== Starting application ==="
          DB_HOST=127.0.0.1 \
          DB_PORT=5432 \
          DB_NAME=springdb \
          DB_USER=springapp \
          DB_PASS='Bucet1nh486' \
          nohup java -jar target/daytrader-spring-1.0.0-SNAPSHOT.jar \
            --spring.profiles.active=prod \
            > /tmp/daytrader-spring.log 2>&1 &

          echo "=== Waiting for startup ==="
          sleep 15

          echo "=== Health check ==="
          if curl -sf http://localhost:9082/actuator/health; then
            echo ""
            echo "Application is UP"
          else
            echo "Application may still be starting. Check /tmp/daytrader-spring.log"
            tail -20 /tmp/daytrader-spring.log || true
            exit 1
          fi
          DEPLOY_SCRIPT

      - name: Clean up SSH key
        if: always()
        run: rm -f "$KEY_FILE"

  notify:
    name: Discord Notification
    runs-on: self-hosted
    needs: [build, deploy]
    if: always()
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          BUILD_STATUS: ${{ needs.build.result }}
          DEPLOY_STATUS: ${{ needs.deploy.result }}
        run: |
          if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
            STATUS="SUCCESS"
            COLOR=3066993
            EMOJI=":white_check_mark:"
          else
            STATUS="FAILED"
            COLOR=15158332
            EMOJI=":x:"
          fi

          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          AUTHOR="${{ github.actor }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${EMOJI} DayTrader Spring â€” ${STATUS}",
              "color": ${COLOR},
              "fields": [
                { "name": "Commit", "value": "\`${SHA_SHORT}\`", "inline": true },
                { "name": "Author", "value": "${AUTHOR}", "inline": true },
                { "name": "Build", "value": "${BUILD_STATUS}", "inline": true },
                { "name": "Deploy", "value": "${DEPLOY_STATUS}", "inline": true }
              ],
              "url": "${RUN_URL}",
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            curl -sf -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$DISCORD_WEBHOOK_URL" || echo "Discord notification failed"
          else
            echo "DISCORD_WEBHOOK_URL not set, skipping notification"
          fi
